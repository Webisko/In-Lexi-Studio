name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm ci

      - name: Build Frontend
        env:
          PUBLIC_API_URL: 'https://inlexistudio.com/app/api'
          PUBLIC_BASE_URL: 'https://inlexistudio.com/app'
        run: npm run build

      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_KEY }}
          known_hosts: unnecessary
          if_key_exists: replace

      - name: Adding Known Hosts
        run: ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy Frontend (public_html)
        run: |
          rsync -avz -e "ssh -p ${{ secrets.SSH_PORT }}" --delete ./dist/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:domains/inlexistudio.com/public_html/

      - name: Deploy Backend (cms-app)
        run: |
          rsync -avz -e "ssh -p ${{ secrets.SSH_PORT }}" \
          --exclude 'node_modules' \
          --exclude '.env' \
          --exclude 'dist' \
          --exclude '.git' \
          ./api ./prisma ./admin ./app.js ./package.json ./package-lock.json \
          ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:domains/inlexistudio.com/cms-app/

      - name: Configure Passenger & Restart
        run: |
          ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd domains/inlexistudio.com/cms-app &&
            
            # Create/Overwrite Passenger .htaccess
            echo 'PassengerEnabled on' > .htaccess &&
            echo 'PassengerAppRoot /home/${{ secrets.SSH_USER }}/domains/inlexistudio.com/cms-app' >> .htaccess &&
            echo 'PassengerAppType node' >> .htaccess &&
            echo 'PassengerStartupFile app.js' >> .htaccess &&
            echo 'PassengerNodejs /home/${{ secrets.SSH_USER }}/nodevenv/domains/inlexistudio.com/cms-app/22/bin/node' >> .htaccess &&

            # Install & Restart
            source /home/${{ secrets.SSH_USER }}/nodevenv/domains/inlexistudio.com/cms-app/22/bin/activate &&
            npm install --production &&
            npx prisma generate &&
            touch app.js
          "
