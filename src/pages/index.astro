---
import Layout from '../layouts/Layout.astro';
import { Hero } from '../components/Hero';
import { GallerySlider } from '../components/GallerySlider';
import { WelcomeSection } from '../components/WelcomeSection';
import { AboutFeature } from '../components/AboutFeature';
import { LatestMoments } from '../components/LatestMoments';
import { Collage } from '../components/Collage';
import { Testimonials } from '../components/Testimonials';
import FAQ from '../components/FAQ.astro';
import { getHomePage, getGalleries, getTestimonials, getSettings } from '../lib/api';

const homePage = await getHomePage();
const homePageData = homePage ?? null;
const testimonials = (await getTestimonials()) || [];
const galleries = await getGalleries();
const settings = await getSettings();

const galleryMap: Record<string, any[]> = {};
if (galleries) {
  galleries.forEach((g) => {
    galleryMap[g.category] = g.items;
  });
}
// Fallback structure to prevent crashes if DB is empty
if (!galleryMap['wedding']) galleryMap['wedding'] = [];
if (!galleryMap['portrait']) galleryMap['portrait'] = [];
if (!galleryMap['product']) galleryMap['product'] = [];
---

<Layout
  title={homePage?.meta_title || homePage?.title || settings?.meta_title || settings?.site_name}
  description={homePage?.meta_description || settings?.meta_description}
  seoImage={homePage?.seo_image || homePage?.hero_image}
  settings={settings}
>
  <main>
    <Hero client:load data={homePageData} />
    <GallerySlider client:visible data={galleryMap} />
    <WelcomeSection />
    <AboutFeature />
    <LatestMoments />
    <Collage />
    <Testimonials client:load data={testimonials} />
    <FAQ />
  </main>
</Layout>
